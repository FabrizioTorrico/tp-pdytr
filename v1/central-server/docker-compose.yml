version: '3.8'

services:
  # 1. El Broker de Mensajes (El corazón de la comunicación)
  mqtt-broker:
    image: eclipse-mosquitto:2
    ports:
      - "1883:1883" # Puerto para datos
      - "9001:9001" # Puerto para websockets
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    # Creamos un config básico al vuelo para permitir anónimos (solo para dev)
    command: >
      sh -c "echo 'listener 1883' > /mosquitto/config/mosquitto.conf && 
             echo 'allow_anonymous true' >> /mosquitto/config/mosquitto.conf &&
             echo 'listener 9001' >> /mosquitto/config/mosquitto.conf &&
             echo 'protocol websockets' >> /mosquitto/config/mosquitto.conf &&
             /usr/sbin/mosquitto -c /mosquitto/config/mosquitto.conf"
  # 2. Base de Datos para Métricas (InfluxDB) - Opcional para tarea 3
  # influxdb:
  #   image: influxdb:2.7
  #   ports:
  #     - "8086:8086"
  #   environment:
  #     - DOCKER_INFLUXDB_INIT_MODE=setup
  #     - DOCKER_INFLUXDB_INIT_USERNAME=admin
  #     - DOCKER_INFLUXDB_INIT_PASSWORD=adminpassword
  #     - DOCKER_INFLUXDB_INIT_ORG=tesis
  #     - DOCKER_INFLUXDB_INIT_BUCKET=sensores
